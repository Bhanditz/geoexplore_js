<!DOCTYPE html>
<html lang="en" class="no-skrollr">

  <head>
    <!-- Meta -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="css/geoexplore.css">
    <link rel="stylesheet" type="text/css" href="css/marker_cluster.css">
    <link rel="stylesheet" type="text/css" href="css/marker_cluster_default.css">

    <!-- JAVASCRIPT -->
    <script type='text/javascript' src="js/places.js"></script>
    <script type='text/javascript' src="js/facets_item.js"></script>
    <script type='text/javascript' src="js/secret.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"
   integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ=="
   crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"
   integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg=="
   crossorigin=""></script>
    <script src="js/leaflet.markercluster.js"></script>
  </head>

  <!-- <body class="animsition"> -->
  <body>
  <div class="map-heading">Europeana Geoexplore!</div>
  <div class="map-wrapper">
      <div id="map" class="leaflet-container leaflet-fade-anim leaflet-grab leaflet-touch-drag"></div>
  </div>
    <script type="text/javascript">
        var getRadius = function (density) {
            return 20 + Math.trunc(Math.log10(density) * 10);
        }
        var tile_url = 'https://api.tiles.mapbox.com/v4/mapbox.light/{z}/{x}/{y}.png?access_token=' + token;
        var tiles = L.tileLayer(tile_url, { attribution: 'Europeana Geoexplore', maxZoom: 18 });

        var map = L.map('map', {center: [20, -10], zoom: 2, layers: [tiles]});

        var markers = L.markerClusterGroup({
            iconCreateFunction: function(cluster) {
                // iterate all markers and count
                var markers = cluster.getAllChildMarkers();
                var weight = 0;
                for (var i = 0; i < markers.length; i++) {
                    if(markers[i].options.hasOwnProperty('density')){
                        weight += markers[i].options.density;
                    }
                }

                var ms = getRadius(weight);
                // create the icon with the "weight" count, instead of marker count
                return L.divIcon({
                    html: '<div><span>' + weight + '</span></div>',
                    className: 'marker-cluster marker-cluster-small', iconSize: new L.Point(ms, ms)
                });
            }
        });


        for (var e in places)
        {
            var geo = places[e];
            var longitude = parseFloat(geo[0]);
            var latitude  = parseFloat(geo[1]);
            if (isNaN(longitude) || isNaN(latitude)) { continue; }

            var density = facets_item[e];
            var ms = getRadius(density);

            var scaledIcon = L.divIcon({
                html: '<div><span>' + density + '</span></div>',
                className: 'marker-cluster marker-cluster-small', iconSize: new L.Point(ms, ms)
            });

            marker = L.marker([latitude, longitude], { title: e, density: density, icon: scaledIcon });
            marker.bindPopup("<div><p>" + e + "</p><p>" + density + " Records/Entities</p></div>");
            markers.addLayer(marker);
        }

        map.addLayer(markers);
    </script>
    <!-- /.JS -->
</body>
</html>
